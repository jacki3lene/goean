package main

import (
  "fmt"
  "sync"
  "time"
  "github.com/jacki3lene/goean/api"
)

func main() {
  defer timeTrack(time.Now(), "main")

  hotelIds := []int{451222,451542,453828,311650,451566,455031,449492,443246,452366,451421,451666,456378,450340,455092,460941,460678,327134,464692,448781,450929,457456,457357,460672,470085,458721,455321,456634,455025,464815,476077,483440,482320,478450,464207,460713,462555,483370,483856,486204,482189,482216,477633,479031,483980,490834,463458,464096,463600,475490,463479,474710,479833,464821,463445,471345,461184,460762,482865,476049,482574,464777,486200,463476,464039,461164,466324,481921,464622,479772,482212,464676,482160,474761,474907,462521,464586,463030,470860,484355,395250,107274,206085,195607,324880,251236,246739,372520,265410,396216,374835,257535,274092,389838,268584,347115,114876,324141,246312,384543,273255,372751,312027,419902,413904,409029,419463,421359,417834,434505,426666,332643,416066,443022,409574,413515,427218,426777,440205,440791,439159,435259,386769,426844,421307,426605,414167,412577,421981,425387,308666,431550,441728,390904,241448,247628,345311,327128,314168,371888,120350,365954,321190,354526,379504,327130,105558,311196,367125,106505,130649,126215,116879,246314,188050,174058,186913,214522,227246,313916,160586,234772,256444,348382,323706,253581,131752,311427,151380,381206,362312,357092,250305,346660,366078,393657,392304,327150,254557,271000,333013,438866,443417,426716,413396,463751,464539,464752,403156,451091,453507,415169,426735,450789,417807,416064,444421,424035,394764,422938,443387}
  response := make(chan string)

  var wg sync.WaitGroup
  var batchNum = 20

  wg.Add(len(hotelIds)/batchNum)

  for i := 0; i < len(hotelIds); i += batchNum {
    batch := hotelIds[i:min(i+batchNum, len(hotelIds))]
    go getAvailability(batch, "12/23/2015", "12/25/2015", response, &wg)
  }

  items := make([]string, 0)

  go func() {
    for {
      item, ok := <- response
      if !ok {
        break
      }
      //fmt.Println(item)
      items = append(items, item)
    }
  }()

  wg.Wait()

  fmt.Println(len(items))
}

func getAvailability(hotelIds []int, checkIn string, checkOut string, response chan string, wg *sync.WaitGroup){
  api.List(hotelIds, checkIn, checkOut, response, wg)
}

func min(a, b int) int {
  if a <= b {
    return a
  }
  return b
}

func timeTrack(start time.Time, name string) {
  elapsed := time.Since(start)
  fmt.Printf("%s took %s", name, elapsed)
}